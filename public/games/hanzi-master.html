<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ±‰å­—å°èƒ½æ‰‹ - HomeStroy æ¸¸æˆå¤§å…</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      min-height: 100vh;
      color: white;
    }

    .game-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .game-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .game-title {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
    }

    .stat-item {
      background: rgba(255,255,255,0.2);
      padding: 10px 25px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.8;
    }

    .stat-value {
      font-size: 28px;
      font-weight: bold;
    }

    .game-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
    }

    .character-display {
      font-size: 150px;
      margin-bottom: 30px;
      text-shadow: 4px 4px 8px rgba(0,0,0,0.3);
      animation: bounce 0.5s ease;
    }

    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .hint-text {
      font-size: 24px;
      margin-bottom: 20px;
      opacity: 0.9;
    }

    .options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      max-width: 500px;
      width: 100%;
    }

    .option-btn {
      padding: 20px 30px;
      font-size: 22px;
      background: white;
      color: #333;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }

    .option-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }

    .option-btn.correct {
      background: #4caf50;
      color: white;
      animation: correct 0.5s ease;
    }

    .option-btn.wrong {
      background: #f44336;
      color: white;
      animation: wrong 0.5s ease;
    }

    @keyframes correct {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes wrong {
      0%, 25%, 50%, 75%, 100% { transform: translateX(0); }
      12.5%, 62.5% { transform: translateX(-10px); }
      37.5%, 87.5% { transform: translateX(10px); }
    }

    .timer-bar {
      width: 100%;
      max-width: 500px;
      height: 10px;
      background: rgba(255,255,255,0.3);
      border-radius: 5px;
      margin-top: 30px;
      overflow: hidden;
    }

    .timer-fill {
      height: 100%;
      background: white;
      transition: width 0.1s linear;
    }

    .start-screen, .game-over-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }

    .start-screen.hidden, .game-over-screen.hidden {
      display: none;
    }

    .start-screen h1 {
      font-size: 72px;
      margin-bottom: 20px;
      text-shadow: 0 0 30px #ff6b6b;
    }

    .start-screen p {
      font-size: 20px;
      margin-bottom: 30px;
      opacity: 0.8;
      max-width: 600px;
      text-align: center;
      line-height: 1.6;
    }

    .mode-selector {
      margin-bottom: 30px;
    }

    .mode-selector label {
      display: block;
      margin-bottom: 15px;
      font-size: 18px;
      cursor: pointer;
    }

    .mode-selector input[type="radio"] {
      margin-right: 10px;
      width: 20px;
      height: 20px;
    }

    .start-btn, .restart-btn {
      padding: 20px 60px;
      font-size: 24px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-weight: bold;
    }

    .start-btn:hover, .restart-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
    }

    .game-over-screen h1 {
      font-size: 64px;
      margin-bottom: 30px;
      color: #ff6b6b;
    }

    .final-stats {
      text-align: center;
      margin-bottom: 30px;
    }

    .final-stats p {
      font-size: 20px;
      margin: 10px 0;
    }

    .final-stats .final-score {
      font-size: 72px;
      color: #ff6b6b;
      margin: 20px 0;
    }

    .high-scores {
      display: flex;
      gap: 30px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .high-score-item {
      text-align: center;
      background: rgba(255,255,255,0.1);
      padding: 15px 25px;
      border-radius: 10px;
    }

    .high-score-label {
      font-size: 14px;
      opacity: 0.7;
    }

    .high-score-value {
      font-size: 28px;
      font-weight: bold;
      color: #ffff00;
    }

    .streak-display {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 18px;
    }

    .streak-display.hot {
      background: linear-gradient(135deg, #ff6b6b, #ff9f43);
      animation: pulse 0.5s infinite alternate;
    }

    @keyframes pulse {
      from { transform: scale(1); }
      to { transform: scale(1.05); }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="game-header">
      <div class="game-title">ğŸ“ æ±‰å­—å°èƒ½æ‰‹</div>
      <div class="stats">
        <div class="stat-item">
          <div class="stat-label">åˆ†æ•°</div>
          <div class="stat-value" id="score">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">æ­£ç¡®</div>
          <div class="stat-value" id="correct">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">é”™è¯¯</div>
          <div class="stat-value" id="wrong">0</div>
        </div>
      </div>
    </div>

    <div class="streak-display" id="streakDisplay">
      ğŸ”¥ è¿å‡»: <span id="streak">0</span>
    </div>

    <div class="game-area">
      <div class="character-display" id="characterDisplay">å­—</div>
      <div class="hint-text" id="hintText">é€‰æ‹©æ­£ç¡®çš„è¯»éŸ³</div>
      <div class="options" id="options"></div>
      <div class="timer-bar">
        <div class="timer-fill" id="timerFill"></div>
      </div>
    </div>

    <div class="start-screen" id="startScreen">
      <h1>ğŸ“ æ±‰å­—å°èƒ½æ‰‹</h1>
      <p>
        æŒ‘æˆ˜ä½ çš„æ±‰å­—è®¤è¯»èƒ½åŠ›ï¼<br>
        æ ¹æ®æ˜¾ç¤ºçš„æ±‰å­—ï¼Œé€‰æ‹©æ­£ç¡®çš„è¯»éŸ³æˆ–å«ä¹‰ã€‚<br>
        å›ç­”è¶Šå¿«ï¼Œå¾—åˆ†è¶Šé«˜ï¼è¿ç»­ç­”å¯¹å¯è·å¾—è¿å‡»åŠ åˆ†ï¼
      </p>
      <div class="mode-selector">
        <label>
          <input type="radio" name="mode" value="pinyin" checked>
          æ‹¼éŸ³æ¨¡å¼ - é€‰æ‹©æ­£ç¡®çš„æ‹¼éŸ³
        </label>
        <label>
          <input type="radio" name="mode" value="meaning">
          é‡Šä¹‰æ¨¡å¼ - é€‰æ‹©æ­£ç¡®çš„å«ä¹‰
        </label>
      </div>
      <button class="start-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
    </div>

    <div class="game-over-screen hidden" id="gameOverScreen">
      <h1>â° æ¸¸æˆç»“æŸ</h1>
      <div class="final-stats">
        <p>æœ€ç»ˆåˆ†æ•°</p>
        <div class="final-score" id="finalScore">0</div>
        <p>æ­£ç¡®: <span id="finalCorrect">0</span> | é”™è¯¯: <span id="finalWrong">0</span></p>
        <p>æ­£ç¡®ç‡: <span id="accuracy">0</span>%</p>
        <p>æœ€é«˜è¿å‡»: <span id="maxStreak">0</span></p>
      </div>
      <div class="high-scores">
        <div class="high-score-item">
          <div class="high-score-label">ä»Šæ—¥æœ€é«˜</div>
          <div class="high-score-value" id="dailyBest">0</div>
        </div>
        <div class="high-score-item">
          <div class="high-score-label">æœ¬å‘¨æœ€é«˜</div>
          <div class="high-score-value" id="weeklyBest">0</div>
        </div>
        <div class="high-score-item">
          <div class="high-score-label">å†å²æœ€é«˜</div>
          <div class="high-score-value" id="allTimeBest">0</div>
        </div>
      </div>
      <button class="restart-btn" onclick="restartGame()">å†æ¥ä¸€å±€</button>
    </div>
  </div>

  <script>
    const GAME_ID = 'hanzi-master';
    
    // Character database with pinyin and meanings
    const characters = [
      { char: 'æ—¥', pinyin: 'rÃ¬', meaning: 'å¤ªé˜³' },
      { char: 'æœˆ', pinyin: 'yuÃ¨', meaning: 'æœˆäº®' },
      { char: 'æ°´', pinyin: 'shuÇ', meaning: 'æ°´' },
      { char: 'ç«', pinyin: 'huÇ’', meaning: 'ç«ç„°' },
      { char: 'å±±', pinyin: 'shÄn', meaning: 'å±±å³°' },
      { char: 'çŸ³', pinyin: 'shÃ­', meaning: 'çŸ³å¤´' },
      { char: 'ç”°', pinyin: 'tiÃ¡n', meaning: 'ç”°åœ°' },
      { char: 'åœŸ', pinyin: 'tÇ”', meaning: 'åœŸåœ°' },
      { char: 'æœ¨', pinyin: 'mÃ¹', meaning: 'æ ‘æœ¨' },
      { char: 'é‡‘', pinyin: 'jÄ«n', meaning: 'é‡‘å­' },
      { char: 'äºº', pinyin: 'rÃ©n', meaning: 'äººç±»' },
      { char: 'å£', pinyin: 'kÇ’u', meaning: 'å˜´å·´' },
      { char: 'æ‰‹', pinyin: 'shÇ’u', meaning: 'æ‰‹æŒ' },
      { char: 'è¶³', pinyin: 'zÃº', meaning: 'è„š' },
      { char: 'ç›®', pinyin: 'mÃ¹', meaning: 'çœ¼ç›' },
      { char: 'è€³', pinyin: 'Ä›r', meaning: 'è€³æœµ' },
      { char: 'å¿ƒ', pinyin: 'xÄ«n', meaning: 'å¿ƒè„' },
      { char: 'å¤§', pinyin: 'dÃ ', meaning: 'å¤§çš„' },
      { char: 'å°', pinyin: 'xiÇo', meaning: 'å°çš„' },
      { char: 'ä¸Š', pinyin: 'shÃ ng', meaning: 'ä¸Šé¢' },
      { char: 'ä¸‹', pinyin: 'xiÃ ', meaning: 'ä¸‹é¢' },
      { char: 'å·¦', pinyin: 'zuÇ’', meaning: 'å·¦è¾¹' },
      { char: 'å³', pinyin: 'yÃ²u', meaning: 'å³è¾¹' },
      { char: 'å¤©', pinyin: 'tiÄn', meaning: 'å¤©ç©º' },
      { char: 'åœ°', pinyin: 'dÃ¬', meaning: 'å¤§åœ°' },
      { char: 'é£', pinyin: 'fÄ“ng', meaning: 'é£' },
      { char: 'é›¨', pinyin: 'yÇ”', meaning: 'é›¨æ°´' },
      { char: 'é›ª', pinyin: 'xuÄ›', meaning: 'é›ªèŠ±' },
      { char: 'äº‘', pinyin: 'yÃºn', meaning: 'äº‘å½©' },
      { char: 'èŠ±', pinyin: 'huÄ', meaning: 'èŠ±æœµ' },
      { char: 'è‰', pinyin: 'cÇo', meaning: 'è‰' },
      { char: 'é¸Ÿ', pinyin: 'niÇo', meaning: 'é¸Ÿç±»' },
      { char: 'é±¼', pinyin: 'yÃº', meaning: 'é±¼ç±»' },
      { char: 'è™«', pinyin: 'chÃ³ng', meaning: 'è™«å­' },
      { char: 'é©¬', pinyin: 'mÇ', meaning: 'é©¬' },
      { char: 'ç‰›', pinyin: 'niÃº', meaning: 'ç‰›' },
      { char: 'ç¾Š', pinyin: 'yÃ¡ng', meaning: 'ç¾Š' },
      { char: 'ç‹—', pinyin: 'gÇ’u', meaning: 'ç‹—' },
      { char: 'çŒ«', pinyin: 'mÄo', meaning: 'çŒ«' },
      { char: 'å®¶', pinyin: 'jiÄ', meaning: 'å®¶åº­' },
      { char: 'å›½', pinyin: 'guÃ³', meaning: 'å›½å®¶' },
      { char: 'å­¦', pinyin: 'xuÃ©', meaning: 'å­¦ä¹ ' },
      { char: 'ä¹¦', pinyin: 'shÅ«', meaning: 'ä¹¦æœ¬' },
      { char: 'ç¬”', pinyin: 'bÇ', meaning: 'ç¬”' },
      { char: 'è½¦', pinyin: 'chÄ“', meaning: 'è½¦è¾†' },
      { char: 'èˆ¹', pinyin: 'chuÃ¡n', meaning: 'èˆ¹åª' },
      { char: 'é£', pinyin: 'fÄ“i', meaning: 'é£ç¿”' },
      { char: 'èµ°', pinyin: 'zÇ’u', meaning: 'èµ°è·¯' },
      { char: 'è·‘', pinyin: 'pÇo', meaning: 'è·‘æ­¥' },
      { char: 'çœ‹', pinyin: 'kÃ n', meaning: 'çœ‹è§' }
    ];

    let gameState = {
      isRunning: false,
      mode: 'pinyin',
      score: 0,
      correct: 0,
      wrong: 0,
      streak: 0,
      maxStreak: 0,
      currentQuestion: null,
      timeLeft: 10,
      totalTime: 60,
      questionCount: 0,
      maxQuestions: 20
    };

    let timerInterval = null;
    let questionTimer = null;

    async function loadHighScores() {
      try {
        const response = await fetch(`/api/game-scores/${GAME_ID}`);
        return await response.json();
      } catch (error) {
        console.error('åŠ è½½åˆ†æ•°å¤±è´¥:', error);
        return { dailyBest: { score: 0 }, weeklyBest: { score: 0 }, allTimeBest: { score: 0 } };
      }
    }

    async function submitScore(finalScore) {
      try {
        const response = await fetch(`/api/game-scores/${GAME_ID}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ score: finalScore })
        });
        return await response.json();
      } catch (error) {
        console.error('æäº¤åˆ†æ•°å¤±è´¥:', error);
        return { isNewRecord: false };
      }
    }

    function shuffleArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function generateQuestion() {
      const correctChar = characters[Math.floor(Math.random() * characters.length)];
      const wrongChars = shuffleArray(characters.filter(c => c.char !== correctChar.char)).slice(0, 3);
      
      const correctAnswer = gameState.mode === 'pinyin' ? correctChar.pinyin : correctChar.meaning;
      const wrongAnswers = wrongChars.map(c => gameState.mode === 'pinyin' ? c.pinyin : c.meaning);
      
      const options = shuffleArray([correctAnswer, ...wrongAnswers]);
      
      gameState.currentQuestion = {
        char: correctChar.char,
        correctAnswer: correctAnswer,
        options: options
      };

      document.getElementById('characterDisplay').textContent = correctChar.char;
      document.getElementById('characterDisplay').style.animation = 'none';
      setTimeout(() => {
        document.getElementById('characterDisplay').style.animation = 'bounce 0.5s ease';
      }, 10);
      
      document.getElementById('hintText').textContent = 
        gameState.mode === 'pinyin' ? 'é€‰æ‹©æ­£ç¡®çš„æ‹¼éŸ³' : 'é€‰æ‹©æ­£ç¡®çš„å«ä¹‰';

      const optionsContainer = document.getElementById('options');
      optionsContainer.innerHTML = options.map((opt, i) => 
        `<button class="option-btn" onclick="selectAnswer('${opt}')">${opt}</button>`
      ).join('');

      // Reset timer
      gameState.timeLeft = 10;
      document.getElementById('timerFill').style.width = '100%';
    }

    function selectAnswer(answer) {
      if (!gameState.isRunning) return;

      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach(btn => btn.disabled = true);

      const isCorrect = answer === gameState.currentQuestion.correctAnswer;

      buttons.forEach(btn => {
        if (btn.textContent === gameState.currentQuestion.correctAnswer) {
          btn.classList.add('correct');
        } else if (btn.textContent === answer && !isCorrect) {
          btn.classList.add('wrong');
        }
      });

      if (isCorrect) {
        const timeBonus = Math.floor(gameState.timeLeft);
        const streakBonus = Math.min(gameState.streak, 10);
        const points = 10 + timeBonus + streakBonus;
        
        gameState.score += points;
        gameState.correct++;
        gameState.streak++;
        if (gameState.streak > gameState.maxStreak) {
          gameState.maxStreak = gameState.streak;
        }
      } else {
        gameState.wrong++;
        gameState.streak = 0;
      }

      updateDisplay();
      gameState.questionCount++;

      setTimeout(() => {
        if (gameState.questionCount >= gameState.maxQuestions) {
          endGame();
        } else {
          generateQuestion();
        }
      }, 1000);
    }

    function updateDisplay() {
      document.getElementById('score').textContent = gameState.score;
      document.getElementById('correct').textContent = gameState.correct;
      document.getElementById('wrong').textContent = gameState.wrong;
      document.getElementById('streak').textContent = gameState.streak;

      const streakDisplay = document.getElementById('streakDisplay');
      if (gameState.streak >= 5) {
        streakDisplay.classList.add('hot');
      } else {
        streakDisplay.classList.remove('hot');
      }
    }

    function updateQuestionTimer() {
      gameState.timeLeft -= 0.1;
      const percentage = (gameState.timeLeft / 10) * 100;
      document.getElementById('timerFill').style.width = Math.max(0, percentage) + '%';

      if (gameState.timeLeft <= 0) {
        selectAnswer('');
      }
    }

    function startGame() {
      const selectedMode = document.querySelector('input[name="mode"]:checked').value;
      
      gameState = {
        isRunning: true,
        mode: selectedMode,
        score: 0,
        correct: 0,
        wrong: 0,
        streak: 0,
        maxStreak: 0,
        currentQuestion: null,
        timeLeft: 10,
        totalTime: 60,
        questionCount: 0,
        maxQuestions: 20
      };

      updateDisplay();
      document.getElementById('startScreen').classList.add('hidden');
      document.getElementById('gameOverScreen').classList.add('hidden');

      questionTimer = setInterval(updateQuestionTimer, 100);
      generateQuestion();
    }

    async function endGame() {
      gameState.isRunning = false;
      if (questionTimer) clearInterval(questionTimer);

      const total = gameState.correct + gameState.wrong;
      const accuracy = total > 0 ? Math.round((gameState.correct / total) * 100) : 0;

      document.getElementById('finalScore').textContent = gameState.score;
      document.getElementById('finalCorrect').textContent = gameState.correct;
      document.getElementById('finalWrong').textContent = gameState.wrong;
      document.getElementById('accuracy').textContent = accuracy;
      document.getElementById('maxStreak').textContent = gameState.maxStreak;
      
      const result = await submitScore(gameState.score);
      
      document.getElementById('dailyBest').textContent = result.dailyBest || 0;
      document.getElementById('weeklyBest').textContent = result.weeklyBest || 0;
      document.getElementById('allTimeBest').textContent = result.allTimeBest || 0;

      document.getElementById('gameOverScreen').classList.remove('hidden');
    }

    function restartGame() {
      document.getElementById('gameOverScreen').classList.add('hidden');
      document.getElementById('startScreen').classList.remove('hidden');
    }
  </script>
</body>
</html>
